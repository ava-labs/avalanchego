# https://taskfile.dev
# To run on a system without task installed, `./scripts/run_task.sh` will execute it with `go run`.
# If in the nix dev shell, `task` is available.
# To install nix, `./scripts/run_task.sh install-nix`

# - Tasks should be simple entrypoints to functionality exposed by scripts or code.
# - Avoid the temptation to use task vars to define an API surface. Prefer configuring the
#   underlying script or code via CLI args and/or env vars.

version: '3'

includes:
  packaging:
    taskfile: .github/packaging/Taskfile.yml

tasks:
  default: ./scripts/run_task.sh --list

  bazel-build:
    desc: Build avalanchego with Bazel
    cmd: bazel build //main:avalanchego

  bazel-build-race:
    desc: Build avalanchego with Bazel (race detection)
    cmd: bazel build --config=race //main:avalanchego

  bazel-build-opt:
    desc: Build avalanchego with Bazel (optimized)
    cmd: bazel build --compilation_mode=opt //main:avalanchego

  bazel-gazelle-delete:
    desc: Delete all gazelle-generated BUILD.bazel files (except manually maintained ones)
    cmd: |
      find . -name 'BUILD.bazel' -type f | while read f; do
        # Skip root and graft module roots (manually maintained)
        case "$f" in
          ./BUILD.bazel|./graft/coreth/BUILD.bazel|./graft/evm/BUILD.bazel|./graft/subnet-evm/BUILD.bazel|./.bazel/*)
            continue
            ;;
        esac
        # Skip files with '# keep' comments (have manual customizations)
        if grep -q '# keep' "$f"; then
          continue
        fi
        rm -f "$f"
      done

  bazel-gazelle-generate:
    desc: Ensure BUILD files are up-to-date by deleting and generating with Gazelle (all modules)
    cmds:
      - task: bazel-gazelle-delete
      - bazel run //:gazelle
      - bazel run //graft/coreth:gazelle
      - bazel run //graft/evm:gazelle
      - bazel run //graft/subnet-evm:gazelle

  bazel-test:
    desc: Run unit tests with Bazel (shuffle on, race on)
    cmd: bazel test //...

  bazel-test-fast:
    desc: Run unit tests with Bazel (no race, no shuffle - faster local iteration)
    cmd: bazel test --config=fast //...

  bazel-clean:
    desc: Clean Bazel cache
    cmd: bazel clean

  bazel-clean-all:
    desc: Clean Bazel cache (full expunge)
    cmd: bazel clean --expunge

  bazel-query:
    desc: Query Bazel targets
    cmd: bazel query '//...' {{.CLI_ARGS}}

  bazel-mod-tidy:
    desc: Update use_repo() in MODULE.bazel from go.mod
    cmd: bazel mod tidy

  bazel-fmt:
    desc: Format BUILD.bazel files with buildifier
    cmd: buildifier -r .

  bazel-test-e2e:
    desc: Run E2E tests with bazel-built binary
    cmds:
      - task: bazel-build
      - task: build-xsvm
      - cmd: |
          AVALANCHEGO_PATH=$(pwd)/bazel-bin/main/avalanchego_/avalanchego \
          bash -x ./scripts/tests.e2e.existing.sh

  bazel-test-e2e-ci:
    desc: Run E2E tests with bazel-built binary [serially with race detection]
    env:
      E2E_SERIAL: 1
    cmds:
      - task: bazel-build-race
      - task: build-xsvm
      - cmd: |
          AVALANCHEGO_PATH=$(pwd)/bazel-bin/main/avalanchego_/avalanchego \
          bash -x ./scripts/tests.e2e.existing.sh

  build:
    desc: Builds avalanchego
    cmd: ./scripts/build.sh

  build-antithesis-images-avalanchego:
    desc: Builds docker images for antithesis for the avalanchego test setup
    env:
      TEST_SETUP: avalanchego
    cmd: bash -x ./scripts/build_antithesis_images.sh

  build-antithesis-images-subnet-evm:
    desc: Builds docker images for antithesis for the subnet-evm test setup
    dir: graft/subnet-evm
    cmd: bash -x ./scripts/build_antithesis_images.sh

  build-antithesis-images-xsvm:
    desc: Builds docker images for antithesis for the xsvm test setup
    env:
      TEST_SETUP: xsvm
    cmd: bash -x ./scripts/build_antithesis_images.sh

  build-bootstrap-monitor:
    desc: Builds bootstrap-monitor
    cmd: ./scripts/build_bootstrap_monitor.sh

  build-bootstrap-monitor-image:
    desc: Builds docker image for bootstrap-monitor
    cmd: ./scripts/build_bootstrap_monitor_image.sh

  build-image:
    desc: Builds docker image for avalanchego
    cmd: ./scripts/build_image.sh

  build-race:
    desc: Builds avalanchego with race detection enabled
    cmd: ./scripts/build.sh -r

  build-subnet-evm-image:
    desc: Builds docker image for subnet-evm
    dir: graft/subnet-evm
    cmd: ./scripts/build_docker_image.sh

  build-tmpnetctl:
    desc: Builds tmpnetctl
    cmd: ./scripts/build_tmpnetctl.sh

  build-xsvm:
    desc: Builds xsvm plugin
    cmd: ./scripts/build_xsvm.sh

  build-xsvm-image:
    desc: Builds xsvm image
    cmd: ./scripts/build_xsvm_image.sh

  check-bazel-fmt:
    desc: Check that BUILD.bazel files are formatted with buildifier
    cmds:
      - task: bazel-fmt
      - task: check-clean-branch

  check-bazel-gazelle-generate:
    desc: Check that generated BUILD files are up-to-date (requires clean git tree)
    cmds:
      - task: bazel-gazelle-generate
      - task: check-clean-branch

  check-clean-branch:
    desc: Checks that the git working tree is clean
    cmd: .github/workflows/check-clean-branch.sh

  check-generate-canoto:
    desc: Checks that generated canoto is up-to-date (requires a clean git working tree)
    cmds:
      - task: generate-canoto
      - task: check-clean-branch

  check-generate-load-contract-bindings:
    desc: Checks that generated load contract bindings are up-to-date (requires a clean git working tree)
    cmds:
      - task: generate-load-contract-bindings
      - task: check-clean-branch

  check-generate-mocks:
    desc: Checks that generated mocks are up-to-date (requires a clean git working tree)
    cmds:
      - task: generate-mocks
      - task: check-clean-branch

  check-generate-protobuf:
    desc: Checks that generated protobuf is up-to-date (requires a clean git working tree)
    cmds:
      - task: generate-protobuf
      - task: check-clean-branch

  check-go-mod-tidy:
    desc: Checks that go module configuration is consistent (requires a clean git working tree)
    cmds:
      - task: go-mod-tidy
      - task: check-clean-branch

  check-go-version:
    desc: Checks that go version directives are consistent across all modules
    cmd: ./scripts/check_go_version.sh

  create-kind-cluster:
    desc: Creates the default kind cluster
    cmd: bash -x ./scripts/start_kind_cluster.sh {{.CLI_ARGS}}

  delete-kind-cluster:
    desc: Deletes the default kind cluster
    cmd: kind delete cluster

  export-cchain-block-range:
    desc: Export range of C-Chain blocks from source to target directory.
    cmd: go run github.com/ava-labs/avalanchego/tests/reexecute/blockexport {{.CLI_ARGS}}

  generate-canoto:
    desc: Generates canoto
    cmd: go generate -run "canoto" ./...

  generate-load-contract-bindings:
    desc: Generates load contract bindings
    cmds:
      - cmd: grep -lr -E '^// Code generated - DO NOT EDIT\.$' tests/load | xargs -r rm
      - cmd: go generate ./tests/load/...

  generate-mocks:
    desc: Generates testing mocks
    cmds:
      # Avoid deleting mocks in grafted modules
      - cmd: grep -lr -E '^// Code generated by MockGen\. DO NOT EDIT\.$' . | grep -v '^./graft' | xargs -r rm
      - cmd: go generate -run "mockgen" ./...

  generate-protobuf:
    desc: Generates protobuf
    cmd: ./scripts/protobuf_codegen.sh

  ginkgo-build:
    desc: Runs ginkgo against the current working directory
    cmd: ./bin/ginkgo build {{.USER_WORKING_DIR}}

  go-mod-tidy:
    desc: Ensures that go module configuration is consistent
    cmds:
      # GOWORK=off is required because lint tooling runs with GOWORK=off
      # (see scripts/run_tool.sh) and dependency resolution differs when
      # the workspace is enabled vs disabled.
      #
      # NOTE: Using explicit 'cd' instead of Task's 'dir:' directive because
      # 'dir:' doesn't properly isolate the go.work context, causing go mod tidy
      # to miss some indirect dependency go.mod hashes in go.sum.
      - cmd: GOWORK=off go mod tidy
      # GOWORK=off is required because tools/external is not part of the workspace
      # and go will otherwise find go.work by walking up the tree
      - cmd: cd tools/external && GOWORK=off go mod tidy
      # GOWORK=off is required for graft modules because lint tooling runs
      # with GOWORK=off (see scripts/run_tool.sh) and dependency resolution
      # differs when the workspace is enabled vs disabled.
      - cmd: cd graft/evm && GOWORK=off go mod tidy
      - cmd: cd graft/coreth && GOWORK=off go mod tidy
      - cmd: cd graft/subnet-evm && GOWORK=off go mod tidy
      - task: sync-go-work
      # Update use_repo() in MODULE.bazel to match go.mod dependencies
      - cmd: bazel mod tidy

  install-nix:
    desc: Installs nix with an OS-appropriate installer
    cmd: ./scripts/install_nix.sh

  lint:
    desc: Runs static analysis tests of golang code
    cmd: ./scripts/lint.sh

  lint-action:
    desc: Runs actionlint to check sanity of github action configuration
    cmd: ./scripts/actionlint.sh

  lint-all:
    desc: Runs all lint checks in parallel
    deps:
      - lint
      - lint-action
      - lint-bazel
      - lint-shell
      - check-go-mod-tidy
      - check-go-version

  lint-all-ci:
    desc: Runs all lint checks one-by-one
    cmds:
      - task: lint
      - task: lint-action
      - task: lint-bazel
      - task: lint-shell
      - task: check-go-mod-tidy
      - task: check-go-version

  lint-bazel:
    desc: Checks Bazel BUILD files are formatted and up-to-date (requires clean git tree)
    cmds:
      - task: check-bazel-fmt
      - task: check-bazel-gazelle-generate

  lint-fix:
    desc: Runs automated fixing for failing static analysis of golang code
    cmd: ./scripts/run_tool.sh golangci-lint run --config .golangci.yml --fix

  lint-shell:
    desc: Runs shellcheck to check sanity of shell scripts
    cmd: ./scripts/shellcheck.sh

  run-polyrepo:
    desc: "Run polyrepo for orchestrating local dependencies. Example: LIBEVM_REF=v1.2.3 FIREWOOD_REF=abc123 task run-polyrepo"
    cmd: ./scripts/run_polyrepo.sh {{.CLI_ARGS}}

  setup-chain-data:
    desc: Sets up C-Chain test data (blocks from S3, state from S3 or empty for genesis).
    cmd: ./scripts/setup_cchain_data.sh

  sync-go-work:
    desc: Downloads module dependencies and syncs go.work.sum
    cmds:
      - cmd: go mod download
      # GOWORK="" ensures workspace mode is enabled (overrides any GOWORK=off in environment)
      - cmd: GOWORK="" go work sync

  test-bootstrap-monitor-e2e:
    desc: Runs bootstrap monitor e2e tests
    cmd: bash -x ./scripts/tests.e2e.bootstrap_monitor.sh

  test-build-antithesis-images-avalanchego:
    desc: Tests the build of antithesis images for the avalanchego test setup
    env:
      TEST_SETUP: avalanchego
    cmds:
      - task: build-race
      - cmd: go run ./tests/antithesis/avalanchego --avalanchego-path=./build/avalanchego --duration=120s
      - cmd: bash -x ./scripts/tests.build_antithesis_images.sh

  test-build-antithesis-images-xsvm:
    desc: Tests the build of antithesis images for the xsvm test setup
    env:
      TEST_SETUP: xsvm
    cmds:
      - task: build-race
      - task: build-xsvm
      - cmd: go run ./tests/antithesis/xsvm --avalanchego-path=./build/avalanchego --duration=120s
      - cmd: bash -x ./scripts/tests.build_antithesis_images.sh

  test-build-image:
    # On mac, docker/podman/lima should work out-of-the-box.
    # On linux, requires qemu (e.g. apt -y install qemu-system qemu-user-static).
    desc: Runs test of cross-platform docker image build
    cmd: bash -x scripts/tests.build_image.sh

  test-cchain-reexecution:
    desc: Runs C-Chain re-execution test. Run without args to see available tests.
    cmd: ./scripts/benchmark_cchain_range.sh {{.CLI_ARGS}}

  test-e2e:
    desc: Runs e2e tests
    cmds:
      - task: build
      - task: build-xsvm
      - cmd: bash -x ./scripts/tests.e2e.sh {{.CLI_ARGS}}

  test-e2e-ci:
    desc: Runs e2e tests [serially with race detection enabled]
    env:
      E2E_SERIAL: 1
    cmds:
      - task: build-race
      - task: build-xsvm
      - cmd: bash -x ./scripts/tests.e2e.sh {{.CLI_ARGS}}

  test-e2e-existing-ci:
    desc: Runs e2e tests with an existing network [serially with race detection enabled]
    env:
      E2E_SERIAL: 1
    cmds:
      - task: build-race
      - task: build-xsvm
      - cmd: bash -x ./scripts/tests.e2e.existing.sh {{.CLI_ARGS}}

  test-e2e-kube:
    desc: Runs e2e tests against a network deployed to kube
    cmds:
      - cmd: bash -x ./scripts/tests.e2e.kube.sh {{.CLI_ARGS}}

  test-e2e-kube-ci:
    # Free github action runners do not have sufficient resources to reliably run a full e2e run against a kube-hosted network
    desc: Runs the xsvm e2e tests in serial against a network deployed to kube
    env:
      E2E_SERIAL: 1
    cmds:
      - cmd: bash -x ./scripts/tests.e2e.kube.sh --ginkgo.focus-file=xsvm.go {{.CLI_ARGS}}

  # test-fuzz targets a single package as a smoke test for fuzz infrastructure.
  # For comprehensive fuzzing, use test-fuzz-long FUZZTIME=[value in seconds].
  # A value of `-1` will run until it encounters a failing output.

  test-fuzz:
    desc: Smoke tests fuzz infrastructure with a quick package
    vars:
      FUZZTIME: '{{.FUZZTIME| default "10"}}'
    cmd: ./scripts/build_fuzz.sh {{.FUZZTIME}} ./utils/cb58

  test-fuzz-long:
    desc: Runs each fuzz test for 180 seconds
    vars:
      FUZZTIME: '{{.FUZZTIME| default "180"}}'
    cmd: ./scripts/build_fuzz.sh {{.FUZZTIME}}

  test-fuzz-merkledb:
    desc: Runs each merkledb fuzz test for 15 minutes
    vars:
      FUZZTIME: '{{.FUZZTIME| default "900"}}'
    cmd: ./scripts/build_fuzz.sh {{.FUZZTIME}} ./x/merkledb

  test-load:
    desc: Runs load tests
    cmds:
      - task: generate-load-contract-bindings
      - task: build
      - cmd: go run ./tests/load/main --avalanchego-path=./build/avalanchego {{.CLI_ARGS}}

  test-load-exclusive:
    desc: Runs load tests against kube with exclusive scheduling
    cmds:
      - cmd: go run ./tests/load/main --runtime=kube --kube-use-exclusive-scheduling {{.CLI_ARGS}}

  test-load-kube:
    desc: Runs load tests against a kubernetes cluster
    cmds:
      - task: generate-load-contract-bindings
      - cmd: go run ./tests/load/main --runtime=kube {{.CLI_ARGS}}

  test-load-kube-kind:
    desc: Runs load tests against a kind cluster
    cmds:
      - task: generate-load-contract-bindings
      - cmd: bash -x ./scripts/tests.load.kube.kind.sh {{.CLI_ARGS}}

  test-robustness:
    desc: Deploys kind with chaos mesh. Intended to eventually run a robustness (fault-injection) test suite.
    cmds:
      - ./bin/tmpnetctl start-kind-cluster --install-chaos-mesh

  test-unit:
    desc: Runs unit tests
    # Invoking with bash ensures compatibility with CI execution on Windows
    cmd: bash ./scripts/build_test.sh

  test-unit-fast:
    desc: Runs unit tests
    env:
      NO_SHUFFLE: TRUE # Allows caching
      NO_RACE: TRUE    # Tests are much faster without race detection
    cmd: bash ./scripts/build_test.sh

  test-upgrade:
    desc: Runs upgrade tests
    cmds:
      - task: build
      - cmd: bash -x ./scripts/tests.upgrade.sh {{.CLI_ARGS}}

  update-go-version:
    desc: "Updates go version directives across all modules. Usage: task update-go-version -- <version> (e.g. 1.25.7)"
    cmds:
      - cmd: ./scripts/set_go_version.sh {{.CLI_ARGS}}
      - task: go-mod-tidy
