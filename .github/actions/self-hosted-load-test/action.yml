name: 'Run Load Test on Self-Hosted Runners'
description: 'Run load tests against Kubernetes cluster on self-hosted runners'

inputs:
  avalanchego_image:
    description: 'AvalancheGo image to test'
    required: false
    default: 'avaplatform/avalanchego:latest'
  exclusive_scheduling:
    description: 'Enable exclusive scheduling'
    required: false
    default: "false"
  duration:
    description: "Load test duration: e.g. 5m, 10m, 1h..."
    required: false
  artifact_prefix:
    description: 'Prefix for artifact names'
    required: false
    default: 'load-test-self-hosted-runners'
  prometheus_username:
    description: 'Prometheus username for monitoring'
    required: true
  prometheus_password:
    description: 'Prometheus password for monitoring'
    required: true
  loki_username:
    description: 'Loki username for logging'
    required: true
  loki_password:
    description: 'Loki password for logging'
    required: true

runs:
  using: composite
  steps:
    - name: Install dependencies
      shell: bash
      # The xz-utils might be present on some containers
      run: |
        if ! command -v xz &> /dev/null; then
          sudo apt-get update
          sudo apt-get install -y xz-utils
        fi
    - name: Run self-hosted load test${{ inputs.exclusive_scheduling == 'true' && ' (exclusive)' || '' }}
      uses: ./.github/actions/run-monitored-tmpnet-cmd
      with:
        run: >-
          ./scripts/run_task.sh test-load-kube --
          --kube-image ${{ inputs.avalanchego_image }}
          ${{ inputs.exclusive_scheduling == 'true' && '--kube-use-exclusive-scheduling' || '' }}
          ${{ inputs.duration && format('--duration {0}', inputs.duration) || '' }}
        artifact_prefix: ${{ inputs.artifact_prefix }}${{ inputs.exclusive_scheduling == 'true' && '-exclusive' || '' }}
        prometheus_username: ${{ inputs.prometheus_username }}
        prometheus_password: ${{ inputs.prometheus_password }}
        loki_username: ${{ inputs.loki_username }}
        loki_password: ${{ inputs.loki_password }}
