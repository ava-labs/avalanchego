name: 'Setup AvalancheGo'
description: 'Setup AvalancheGo with custom dependencies (Firewood, Coreth, LibEVM)'

inputs:
  avalanchego:
    description: 'AvalancheGo version (commit SHA, branch name, or tag)'
    required: false
    default: ${{ github.sha }}
  checkout-path:
    description: 'Path where AvalancheGo will be checked out'
    required: false
    default: '.'
  firewood:
    description: 'Firewood version (commit SHA, branch, tag, or ffi/vX.Y.Z for pre-built)'
    required: false
    default: ''
  firewood-path:
    description: 'Directory path where Firewood will be cloned/built (preferably NVMe storage)'
    required: false
    default: ''
  coreth:
    description: 'Coreth version (commit SHA, branch name, or tag)'
    required: false
    default: ''
  libevm:
    description: 'LibEVM version (commit SHA, branch name, or tag)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Checkout AvalancheGo
      uses: actions/checkout@v4
      with:
        repository: 'ava-labs/avalanchego'
        ref: ${{ inputs.avalanchego }}
        path: ${{ inputs.checkout-path }}
    - name: Update Coreth dependency
      if: inputs.coreth != ''
      shell: bash
      working-directory: ${{ inputs.checkout-path }}
      run: |
        echo "Updating Coreth to version: ${{ inputs.coreth }}"
        go get github.com/ava-labs/coreth@${{ inputs.coreth }}
    - name: Update LibEVM dependency
      if: inputs.libevm != ''
      shell: bash
      working-directory: ${{ inputs.checkout-path }}
      run: |
        echo "Updating LibEVM to version: ${{ inputs.libevm }}"
        go get github.com/ava-labs/libevm@${{ inputs.libevm }}
    - name: Setup Firewood FFI
      if: inputs.firewood != ''
      id: setup-firewood
      uses: ava-labs/firewood/.github/actions/build-action@composable-ci-action
      with:
        version: ${{ inputs.firewood }}
        workspace-path: ${{ inputs.firewood-path }}
    - name: Configure Go modules with Firewood FFI
      if: inputs.firewood != ''
      shell: bash
      working-directory: ${{ inputs.checkout-path }}
      run: |
        FFI_PATH="${{ steps.setup-firewood.outputs.ffi-path }}"
        echo "Updating go.mod with FFI path: ${FFI_PATH}"
        go mod edit -replace github.com/ava-labs/firewood-go-ethhash/ffi="${FFI_PATH}"
        go mod tidy
        go mod download
