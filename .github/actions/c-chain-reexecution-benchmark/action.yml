name: 'C-Chain Re-Execution Benchmark'
description: 'Run C-Chain re-execution benchmark'

inputs:
  test:
    description: 'Test name to run (e.g., hashdb-101-250k). Leave empty to use custom inputs below.'
    default: ''
  # Custom inputs (used when test is not provided)
  config:
    description: 'The config to pass to the VM for the benchmark. See BenchmarkReexecuteRange for details.'
    default: ''
  start-block:
    description: 'The start block for the benchmark.'
    default: ''
  end-block:
    description: 'The end block for the benchmark.'
    default: ''
  block-dir-src:
    description: 'The source block directory. Supports S3 directory/zip and local directories.'
    default: ''
  current-state-dir-src:
    description: 'The current state directory. Supports S3 directory/zip and local directories.'
    default: ''
  runner_type:
    description: 'The type/label of the runner to include in the benchmark name for grouping results.'
    required: true
  aws-role:
    description: 'AWS role to assume for S3 access.'
    required: true
  aws-region:
    description: 'AWS region to use for S3 access.'
    default: 'us-east-2'
  aws-role-duration-seconds:
    description: 'The duration of the AWS role to assume for S3 access.'
    required: true
    default: '43200' # 12 hours
  prometheus-url:
    description: 'The URL of the prometheus instance.'
    required: true
    default: ''
  prometheus-push-url:
    description: 'The push URL of the prometheus instance.'
    required: true
    default: ''
  prometheus-username:
    description: 'The username for the Prometheus instance.'
    required: true
    default: ''
  prometheus-password:
    description: 'The password for the Prometheus instance.'
    required: true
    default: ''
  github-token:
    description: 'GitHub token provided to GitHub Action Benchmark.'
    required: true
  push-github-action-benchmark:
    description: 'Whether to push the benchmark result to GitHub.'
    required: true
  push-post-state:
    description: 'S3 destination to copy the current-state directory after completing re-execution. If empty, this will be skipped.'
    default: ''
  libevm-ref:
    description: 'libevm commit/branch/tag (optional). If provided, updates libevm dependency before benchmark.'
    default: ''
  firewood-ref:
    description: 'Firewood commit/branch/tag (optional). If provided, builds custom firewood and skips benchmark comparison (Firewood tracks separately).'
    default: ''
  # The following inputs need never be provided by the caller. They
  # default to context values that the action's steps are unable to
  # access directly.
  repository-owner:
    default: ${{ github.repository_owner }}
  repository-name:
    default: ${{ github.event.repository.name }}
  workflow:
    default: ${{ github.workflow }}
  run-id:
    default: ${{ github.run_id }}
  run-number:
    default: ${{ github.run_number }}
  run-attempt:
    default: ${{ github.run_attempt }}
  job:
    default: ${{ github.job }}

runs:
  using: composite
  steps:
    - uses: cachix/install-nix-action@02a151ada4993995686f9ed4f1be7cfbb229e56f #v31
      with:
        github_access_token: ${{ inputs.github-token }}
    - run: echo "dependencies installed"
      shell: nix develop --command bash {0}
    # Cache Go modules (architecture-independent)
    - uses: actions/cache@v4
      id: go-mod-cache
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-mod-${{ hashFiles('go.sum') }}
        restore-keys: ${{ runner.os }}-go-mod-
    # Cache Go build cache (architecture-specific)
    - uses: actions/cache@v4
      with:
        path: ~/.cache/go-build
        key: ${{ runner.os }}-${{ runner.arch }}-go-build-${{ hashFiles('go.sum') }}
        restore-keys: ${{ runner.os }}-${{ runner.arch }}-go-build-
    # Download modules only on cache miss
    - run: go mod download
      if: steps.go-mod-cache.outputs.cache-hit != 'true'
      shell: nix develop --command bash -x {0}
    - name: Notify of metrics availability
      if: inputs.prometheus-username != ''
      shell: bash
      run: |
        metrics_url=$($GITHUB_ACTION_PATH/output-metrics-url.sh)
        echo "Grafana: ${metrics_url}"
        echo "ðŸ”— [View Grafana Dashboard](${metrics_url})" >> "$GITHUB_STEP_SUMMARY"
      env:
        GRAFANA_URL: https://grafana-poc.avax-dev.network/d/Gl1I20mnk/c-chain?orgId=1&refresh=10s&var-filter=is_ephemeral_node%7C%3D%7Cfalse&var-filter=gh_repo%7C%3D%7C${{ inputs.repository-owner }}%2F${{ inputs.repository-name }}&var-filter=gh_run_id%7C%3D%7C${{ inputs.run-id }}&var-filter=gh_run_attempt%7C%3D%7C${{ inputs.run-attempt }}
        GH_JOB_ID: ${{ inputs.job }}
    - name: Warn that collection of metrics and logs will not be performed
      if: inputs.prometheus-username == ''
      shell: bash
      run: echo "::warning::Monitoring credentials not found. Skipping collector start. Is the PR from a fork branch?"
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.aws-role }}
        aws-region: ${{ inputs.aws-region }}
        role-duration-seconds: ${{ inputs.aws-role-duration-seconds }}
    - name: Set benchmark output file
      shell: bash
      run: echo "BENCHMARK_OUTPUT_FILE=${GITHUB_WORKSPACE}/benchmark-output.json" >> "$GITHUB_ENV"
    - name: Run C-Chain Re-execution Benchmark
      shell: nix develop --impure --command bash -x {0}
      run: ./scripts/run_task.sh test-cchain-reexecution -- "${{ inputs.test || '' }}"
      env:
        # Test configuration overrides
        BLOCK_DIR_SRC: ${{ inputs.block-dir-src }}
        CURRENT_STATE_DIR_SRC: ${{ inputs.current-state-dir-src }}
        START_BLOCK: ${{ inputs.start-block }}
        END_BLOCK: ${{ inputs.end-block }}
        CONFIG: ${{ inputs.config }}
        # Execution environment
        BENCHMARK_OUTPUT_FILE: ${{ env.BENCHMARK_OUTPUT_FILE }}
        PUSH_POST_STATE: ${{ inputs.push-post-state }}
        # Runner and metrics
        RUNNER_TYPE: ${{ inputs.runner_type }}
        METRICS_COLLECTOR_ENABLED: ${{ inputs.prometheus-username != '' }}
        PROMETHEUS_URL: ${{ inputs.prometheus-url }}
        PROMETHEUS_PUSH_URL: ${{ inputs.prometheus-push-url }}
        PROMETHEUS_USERNAME: ${{ inputs.prometheus-username }}
        PROMETHEUS_PASSWORD: ${{ inputs.prometheus-password }}
        # Github metadata
        GH_REPO: ${{ inputs.repository-owner }}/${{ inputs.repository-name }}
        GH_WORKFLOW: ${{ inputs.workflow }}
        GH_RUN_ID: ${{ inputs.run-id }}
        GH_RUN_NUMBER: ${{ inputs.run-number }}
        GH_RUN_ATTEMPT: ${{ inputs.run-attempt }}
        GH_JOB_ID: ${{ inputs.job }}
        # Required for Nix builds in CI self-hosted runners (e.g., building Firewood via polyrepo)
        TMPDIR: /tmp
        NIX_BUILD_TOP: /tmp
    # Skip when using custom firewood - Firewood downloads the artifact and
    # publishes to their own gh-pages for tracking
    - name: Compare Benchmark Results
      if: inputs.firewood-ref == ''
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'customBiggerIsBetter'
        output-file-path: ${{ env.BENCHMARK_OUTPUT_FILE }}
        summary-always: true
        github-token: ${{ inputs.github-token }}
        auto-push: ${{ inputs.push-github-action-benchmark }}
