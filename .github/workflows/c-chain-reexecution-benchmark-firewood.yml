# Firewood Reexecution Benchmark
#
# This workflow runs C-Chain reexecution benchmarks with custom Firewood builds.
# It's designed to be triggered by the Firewood repository to track performance.
#
# Firewood resolution strategy:
#   1. Try to fetch the requested ref via `go get` (works for tags, branches, commits)
#   2. If that fails, build from source using Nix
#
# Results are uploaded as artifacts for Firewood to download and publish
# to their own GitHub Pages dashboard.

name: Firewood Reexecution Benchmark

on:
  workflow_dispatch:
    inputs:
      firewood:
        description: 'Firewood commit/branch/tag to build and test'
        required: true
      libevm:
        description: 'libevm commit/branch/tag (optional)'
        default: ''
      task:
        description: 'Taskfile task to execute (e.g., c-chain-reexecution-firewood-101-250k, if present custom inputs below are ignored)'
        default: 'c-chain-reexecution-firewood-101-250k'
      config:
        default: ''
      start-block:
        default: ''
      end-block:
        default: ''
      block-dir-src:
        default: ''
      current-state-dir-src:
        default: ''
      runner:
        description: 'Runner to execute the benchmark. Input to the runs-on field of the job.'
        required: true
      push-post-state:
        default: ''

jobs:
  c-chain-reexecution:
    permissions:
      id-token: write
      contents: read
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: ./.github/actions/setup-go-for-project
      - name: Install Nix dependencies
        shell: bash
        run: |
          if ! command -v xz &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y xz-utils
          fi
      - name: Update libevm
        if: inputs.libevm != ''
        shell: bash
        run: |
          echo "Updating libevm to: ${{ inputs.libevm }}"
          go get github.com/ava-labs/libevm@${{ inputs.libevm }}
          cd graft/coreth
          go get github.com/ava-labs/libevm@${{ inputs.libevm }}
      - name: Fetch Firewood via Go modules
        id: fetch-firewood
        shell: bash
        run: |
          cd graft/coreth
          echo "Attempting to fetch Firewood via Go modules: ${{ inputs.firewood }}"
          if go get github.com/ava-labs/firewood-go-ethhash/ffi@${{ inputs.firewood }}; then
            echo "success=true" >> "$GITHUB_OUTPUT"
            echo "Firewood fetched successfully via Go modules."
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            echo "Go module fetch failed; will build from source with Nix."
          fi
      - name: Install Nix
        if: steps.fetch-firewood.outputs.success == 'false'
        uses: cachix/install-nix-action@02a151ada4993995686f9ed4f1be7cfbb229e56f # v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Firewood (from source)
        if: steps.fetch-firewood.outputs.success == 'false'
        shell: bash
        run: ./scripts/run_task.sh build-firewood FIREWOOD_REF="${{ inputs.firewood }}" DIRTY=true
        env:
          TMPDIR: /tmp
          NIX_BUILD_TOP: /tmp
      - name: Run C-Chain Re-Execution Benchmark
        uses: ./.github/actions/c-chain-reexecution-benchmark
        with:
          task: ${{ inputs.task }}
          config: ${{ inputs.config }}
          start-block: ${{ inputs.start-block }}
          end-block: ${{ inputs.end-block }}
          block-dir-src: ${{ inputs.block-dir-src }}
          current-state-dir-src: ${{ inputs.current-state-dir-src }}
          prometheus-url: ${{ secrets.PROMETHEUS_URL || '' }}
          prometheus-push-url: ${{ secrets.PROMETHEUS_PUSH_URL || '' }}
          prometheus-username: ${{ secrets.PROMETHEUS_USERNAME || '' }}
          prometheus-password: ${{ secrets.PROMETHEUS_PASSWORD || '' }}
          push-github-action-benchmark: false # Firewood downloads artifact and publishes to their gh-pages
          aws-role: ${{ inputs.push-post-state != '' && secrets.AWS_S3_RW_ROLE || secrets.AWS_S3_READ_ONLY_ROLE }}
          aws-region: 'us-east-2'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-post-state: ${{ inputs.push-post-state }}
          runner_name: ${{ inputs.runner }}
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-output
          path: ${{ github.workspace }}/benchmark-output.txt
          retention-days: 30
          if-no-files-found: error
