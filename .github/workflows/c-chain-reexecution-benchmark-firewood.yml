name: Firewood Reexecution Benchmark

on:
  workflow_dispatch:
    inputs:
      firewood-commit:
        description: 'Firewood commit/branch/tag to build and test'
        required: true
      task:
        description: 'Taskfile task to execute (e.g., c-chain-reexecution-firewood-101-250k, if present custom inputs below are ignored)'
        default: 'c-chain-reexecution-firewood-101-250k'
      config:
        default: ''
      start-block:
        default: ''
      end-block:
        default: ''
      block-dir-src:
        default: ''
      current-state-dir-src:
        default: ''
      runner:
        description: 'Runner to execute the benchmark. Input to the runs-on field of the job.'
        required: true
      push-post-state:
        default: ''

jobs:
  c-chain-reexecution:
    permissions:
      id-token: write
      contents: write
    runs-on: ${{ inputs.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: ./.github/actions/setup-go-for-project
      - name: Install Nix Dependencies
        shell: bash
        run: |
          # xz-utils might be present on some containers. Install if not present.
          if ! command -v xz &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y xz-utils
          fi
      - name: Install Nix
        uses: cachix/install-nix-action@02a151ada4993995686f9ed4f1be7cfbb229e56f # v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Firewood from source
        shell: bash
        run: |
          cd graft/coreth
          echo "Building Firewood from: ${{ inputs.firewood-commit }}"
          # The script updates go.mod automatically
          ./scripts/build_firewood.sh "${{ inputs.firewood-commit }}" --update
        env:
          TMPDIR: /tmp 
          NIX_BUILD_TOP: /tmp # Updated default Nix build from /home/runner/_work/_temp/ which is a restricted volume on self-hosted runners.
      - name: Mark go.mod changes as assumed unchanged
        shell: bash
        run: |
          git update-index --assume-unchanged graft/coreth/go.mod graft/coreth/go.sum
      - name: Run C-Chain Re-Execution Benchmark
        uses: ./.github/actions/c-chain-reexecution-benchmark
        with:
          task: ${{ inputs.task }}
          config: ${{ inputs.config }}
          start-block: ${{ inputs.start-block }}
          end-block: ${{ inputs.end-block }}
          block-dir-src: ${{ inputs.block-dir-src }}
          current-state-dir-src: ${{ inputs.current-state-dir-src }}
          prometheus-url: ${{ secrets.PROMETHEUS_URL || '' }}
          prometheus-push-url: ${{ secrets.PROMETHEUS_PUSH_URL || '' }}
          prometheus-username: ${{ secrets.PROMETHEUS_USERNAME || '' }}
          prometheus-password: ${{ secrets.PROMETHEUS_PASSWORD || '' }}
          push-github-action-benchmark: false
          aws-role: ${{ inputs.push-post-state != '' && secrets.AWS_S3_RW_ROLE || secrets.AWS_S3_READ_ONLY_ROLE }}
          aws-region: 'us-east-2'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          push-post-state: ${{ inputs.push-post-state }}
          runner_name: ${{ inputs.runner }}
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-output
          path: ${{ github.workspace }}/benchmark-output.txt
          retention-days: 30
          if-no-files-found: error

