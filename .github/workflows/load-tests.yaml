name: Load test on self-hosted runners

# This workflow runs comprehensive load tests against our Kubernetes cluster
on:
  workflow_dispatch:
    inputs:
      image:
        description: 'AvalancheGo image to test'
        required: false
        default: 'avaplatform/avalanchego:latest'
        type: string

jobs:
  load_tests:
    name: Run load test on self-hosted runners
    runs-on: avalanche-avalanchego-runner
    container:
      image: ghcr.io/actions/actions-runner:2.325.0
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xz-utils
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Go for project
        uses: ./.github/actions/setup-go-for-project
      - uses: ./.github/actions/run-monitored-tmpnet-cmd
        with:
          run: ./scripts/run_task.sh test-load-kube -- --kube-image ${{ inputs.image }}
          action_path: .github/actions/run-monitored-tmpnet-cmd
          artifact_prefix: load-self-hosted-runner
          prometheus_username: ${{ secrets.PROMETHEUS_ID || '' }}
          prometheus_password: ${{ secrets.PROMETHEUS_PASSWORD || '' }}
          loki_username: ${{ secrets.LOKI_ID || '' }}
          loki_password: ${{ secrets.LOKI_PASSWORD || '' }}
