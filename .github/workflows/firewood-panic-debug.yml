name: Firewood Panic Debug

on:
  workflow_dispatch:
    inputs:
      firewood-ref:
        description: 'firewood-go-ethhash Git ref (empty = current default)'
        default: ''
        type: string

jobs:
  coreth:
    name: Coreth (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ./graft/coreth
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@02a151ada4993995686f9ed4f1be7cfbb229e56f #v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Override firewood dependency
        if: inputs.firewood-ref != ''
        working-directory: .
        shell: nix develop --command bash {0}
        run: ./scripts/run_task.sh run-polyrepo
        env:
          FIREWOOD_REF: ${{ inputs.firewood-ref }}

      - name: Configure core dumps
        working-directory: .
        run: |
          ulimit -c unlimited
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo mkdir -p /tmp/cores && sudo chmod 1777 /tmp/cores
            echo "/tmp/cores/core.%e.%p.%t" | sudo tee /proc/sys/kernel/core_pattern
          fi

      - name: Run build-test
        id: test
        continue-on-error: true
        shell: nix develop --command bash {0}
        env:
          GOTRACEBACK: crash
        run: |
          set -eo pipefail
          ulimit -c unlimited
          ./scripts/run_task.sh build-test 2>&1 | tee /tmp/test.log

      - name: Upload artifacts
        if: always()
        working-directory: .
        run: |
          mkdir -p /tmp/artifacts
          cp /tmp/test.log /tmp/artifacts/ 2>/dev/null || true
          cp /tmp/cores/core.* /tmp/artifacts/ 2>/dev/null || true
          [[ "$RUNNER_OS" == "macOS" ]] && cp /cores/core.* /tmp/artifacts/ 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coreth-${{ matrix.os }}
          path: /tmp/artifacts/
          retention-days: 14
          if-no-files-found: warn

      - if: steps.test.outcome == 'failure'
        run: exit 1

  subnet-evm:
    name: Subnet-EVM (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        working-directory: ./graft/subnet-evm
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-22.04, ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@02a151ada4993995686f9ed4f1be7cfbb229e56f #v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Override firewood dependency
        if: inputs.firewood-ref != ''
        working-directory: .
        shell: nix develop --command bash {0}
        run: ./scripts/run_task.sh run-polyrepo
        env:
          FIREWOOD_REF: ${{ inputs.firewood-ref }}

      - name: Configure core dumps
        working-directory: .
        run: |
          ulimit -c unlimited
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo mkdir -p /tmp/cores && sudo chmod 1777 /tmp/cores
            echo "/tmp/cores/core.%e.%p.%t" | sudo tee /proc/sys/kernel/core_pattern
          fi

      - name: Run build-test
        id: test
        continue-on-error: true
        shell: nix develop --command bash {0}
        env:
          GOTRACEBACK: crash
        run: |
          set -eo pipefail
          ulimit -c unlimited
          ./scripts/run_task.sh build-test 2>&1 | tee /tmp/test.log

      - name: Upload artifacts
        if: always()
        working-directory: .
        run: |
          mkdir -p /tmp/artifacts
          cp /tmp/test.log /tmp/artifacts/ 2>/dev/null || true
          cp /tmp/cores/core.* /tmp/artifacts/ 2>/dev/null || true
          [[ "$RUNNER_OS" == "macOS" ]] && cp /cores/core.* /tmp/artifacts/ 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: subnet-evm-${{ matrix.os }}
          path: /tmp/artifacts/
          retention-days: 14
          if-no-files-found: warn

      - if: steps.test.outcome == 'failure'
        run: exit 1

