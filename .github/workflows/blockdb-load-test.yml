name: Load Test with BlockDB

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to test (default: current branch)"
        required: false
        default: ""
      duration:
        description: "Load test duration (e.g., 30m, 1h, 2h)"
        required: false
        default: "30m"
      firewood:
        description: "Enable Firewood alongside BlockDB"
        required: false
        default: false
        type: boolean

jobs:
  blockdb-load-test:
    runs-on: avalanche-avalanchego-runner
    container:
      image: ghcr.io/actions/actions-runner:2.325.0
    steps:
      - name: Checkout specified branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Install dependencies
        shell: bash
        run: |
          if ! command -v xz &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y xz-utils
          fi

      - uses: ./.github/actions/setup-go-for-project

      - name: Run BlockDB load test
        uses: ./.github/actions/run-monitored-tmpnet-cmd
        with:
          run: >-
            ./scripts/run_task.sh test-load --
            --load-timeout=${{ github.event.inputs.duration || '30m' }}
            --blockdb
            ${{ github.event.inputs.firewood == 'true' && '--firewood' || '' }}
          artifact_prefix: blockdb-load-test
          prometheus_url: ${{ secrets.PROMETHEUS_URL || '' }}
          prometheus_push_url: ${{ secrets.PROMETHEUS_PUSH_URL || '' }}
          prometheus_username: ${{ secrets.PROMETHEUS_USERNAME || '' }}
          prometheus_password: ${{ secrets.PROMETHEUS_PASSWORD || '' }}
          loki_url: ${{ secrets.LOKI_URL || '' }}
          loki_push_url: ${{ secrets.LOKI_PUSH_URL || '' }}
          loki_username: ${{ secrets.LOKI_USERNAME || '' }}
          loki_password: ${{ secrets.LOKI_PASSWORD || '' }}
