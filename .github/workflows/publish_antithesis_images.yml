name: Publish Antithesis Images

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'The tag to apply to published images'
        default: latest
        required: true
        type: string
  push:
    branches:
      - master

env:
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: molten-verve-216720/avalanche-repository

jobs:
  antithesis:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Login to GAR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: _json_key
        password: ${{ secrets.ANTITHESIS_GAR_JSON_KEY }}

    - name: Build and push images for avalanchego test setup
      run: bash -x ./scripts/build_antithesis_images.sh
      env:
        IMAGE_PREFIX: ${{ env.REGISTRY }}/${{ env.REPOSITORY }}
        TAG: ${{ github.events.inputs.image_tag || 'latest' }}
        TEST_SETUP: avalanchego

    - name: Build and push images for xsvm test setup
      run: bash -x ./scripts/build_antithesis_images.sh
      env:
        IMAGE_PREFIX: ${{ env.REGISTRY }}/${{ env.REPOSITORY }}
        TAG: ${{ github.events.inputs.image_tag || 'latest' }}
        TEST_SETUP: xsvm
