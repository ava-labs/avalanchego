# Bazel Build System

This document explains how Bazel is configured and used in the
avalanchego monorepo.

## Quick Start

```bash
# Build the main binary
task bazel-build

# Build with optimizations
task bazel-build-opt

# Run unit tests
task bazel-test

# Update BUILD.bazel files after changing Go imports
task bazel-gazelle-generate

# Clean build cache
task bazel-clean
```

## Architecture Overview

### Multi-Module Structure

The repository contains multiple Go modules with different licenses:

| Module | Path | License | Import Path |
|--------|------|---------|-------------|
| avalanchego | `/` (root) | BSD-3 | `github.com/ava-labs/avalanchego` |
| coreth | `graft/coreth/` | LGPL-3 | `github.com/ava-labs/avalanchego/graft/coreth` |
| evm | `graft/evm/` | - | `github.com/ava-labs/avalanchego/graft/evm` |
| subnet-evm | `graft/subnet-evm/` | LGPL-3 | `github.com/ava-labs/avalanchego/graft/subnet-evm` |

Each module has its own `go.mod` with `replace` directives pointing to
sibling modules. Bazel handles cross-module imports via `go.work` and
gazelle prefix directives.

### Key Configuration Files

| File | Purpose | Safe to Delete? |
|------|---------|-----------------|
| `MODULE.bazel` | Bazel module definition, dependencies, patches | **No** |
| `MODULE.bazel.lock` | Locked dependency versions | Yes (regenerated) |
| `.bazelrc` | Bazel build flags and settings | **No** |
| `.bazelignore` | Directories excluded from Bazel (`.direnv`) | **No** |
| `BUILD.bazel` (root) | Gazelle config: prefix, exclusions (`tools/`), proto disable | **No** |
| `.bazel/patches/*.patch` | Fixes for external dependencies | **No** |
| `.bazel/defs.bzl` | Custom test macros for graft module timeouts | **No** |

### BUILD.bazel Files with Custom Content

Most BUILD.bazel files are auto-generated by Gazelle, but some have
custom content that would be lost if deleted:

| File | Custom Content |
|------|---------------|
| `BUILD.bazel` (root) | Gazelle directives (`prefix`, `exclude`, `proto`) |
| `main/BUILD.bazel` | `x_defs` for Git commit stamping |
| `graft/coreth/BUILD.bazel` | `gazelle:prefix`, `gazelle:map_kind` for test timeouts |
| `graft/evm/BUILD.bazel` | `gazelle:prefix`, `gazelle:map_kind` for test timeouts |
| `graft/subnet-evm/BUILD.bazel` | `gazelle:prefix`, `gazelle:map_kind` for test timeouts |

**Preserving custom content**: Gazelle directives (`# gazelle:prefix`,
`# gazelle:map_kind`) are automatically preserved. For other custom
content (like `x_defs`), use `# keep` comments to prevent gazelle from
removing them:

```python
x_defs = {  # keep
    "github.com/ava-labs/avalanchego/version.GitCommit": "{STABLE_GIT_COMMIT}",
},
```

**Rule of thumb**: Don't delete BUILD.bazel files that contain gazelle
directives or `# keep` comments.

## Gazelle

[Gazelle](https://github.com/bazelbuild/bazel-gazelle) automatically
generates BUILD.bazel files from Go source code.

### Where Gazelle Comes From

Gazelle is declared as a `bazel_dep` in `MODULE.bazel`. It is **not**
provided by Nix. The recommended entrypoint is `task
bazel-gazelle-generate`, which runs Gazelle for all modules in the repo.

### When to Run Gazelle

Run `task bazel-gazelle-generate` after:
- Adding new `.go` files
- Changing import statements
- Adding new packages/directories
- Modifying `go.mod` dependencies

### How Gazelle Handles Multiple Modules

Each Go module root needs a `BUILD.bazel` with a `gazelle:prefix`
directive:

```python
# graft/coreth/BUILD.bazel
# gazelle:prefix github.com/ava-labs/avalanchego/graft/coreth
```

### Custom Test Macros via `gazelle:map_kind`

The graft modules (coreth, evm, subnet-evm) have longer test timeouts
than the root module. To handle this, custom test macros are defined
in `.bazel/defs.bzl`:

| Macro | Timeout | Used By |
|-------|---------|---------|
| `graft_go_test_900s` | 900s (long) | coreth, subnet-evm |
| `graft_go_test_600s` | 900s (closest to 600s) | evm |

Gazelle automatically uses these macros via `gazelle:map_kind`
directives in each graft module's root BUILD.bazel:

```python
# graft/coreth/BUILD.bazel
# gazelle:prefix github.com/ava-labs/avalanchego/graft/coreth
# gazelle:map_kind go_test graft_go_test_900s //.bazel:defs.bzl
```

This remaps all `go_test` targets in that subtree to use the custom
macro with the longer timeout.

## External Dependency Handling

### Go Dependencies

Go dependencies are managed via the `go_deps` extension in `MODULE.bazel`:

```python
go_deps = use_extension("@bazel_gazelle//:extensions.bzl", "go_deps")
go_deps.from_file(go_work = "//:go.work")
```

The `go.work` file aggregates all module dependencies (root + graft
modules), so dependencies from nested modules are resolved
automatically.

### Patched Dependencies

Some dependencies require patches for Bazel compatibility:

| Dependency | Issue | Solution |
|------------|-------|----------|
| `supranational/blst` | Complex CGO with assembly | Custom BUILD.bazel via patch |
| `ava-labs/libevm` | Missing C sources for secp256k1 | Patch to add sources |
| `consensys/gnark-crypto` | Assembly include paths | Patch asm includes for Bazel sandboxing |
| `firewood-go-ethhash/ffi` | Pre-built static libraries | Custom BUILD.bazel via patch |

Patches are in the `.bazel/patches/` directory and applied in `MODULE.bazel`.

### Protocol Buffers

Proto generation is disabled globally via the root `BUILD.bazel`:

```python
# gazelle:proto disable_global
```

The repository uses pre-generated `.pb.go` files checked into source
control rather than generating them at build time. This avoids proto
toolchain complexity in Bazel while maintaining compatibility with the
existing `go generate` workflow.

## Common Tasks

### Building

```bash
# Build main binary
task bazel-build                    # or: bazel build //main:avalanchego

# Build with optimizations
task bazel-build-opt               # or: bazel build --compilation_mode=opt //main:avalanchego

# Build everything
bazel build //...
```

### Testing

By default, `bazel test` matches `scripts/build_test.sh` behavior,
with a few exceptions:

- The script passes `-tags test` to `go test`; currently there are no
  `//go:build test` files in this repo, so it has no effect.
- The script excludes several directories via `go list | grep -v ...`;
  Bazel instead relies on `tags = ["manual"]` to keep non-unit tests
  out of `bazel test //...`.

```bash
# Run all unit tests (shuffle enabled, race on)
task bazel-test                    # or: bazel test //...

# Run tests for a specific package
bazel test //utils/...

# Run specific test functions (target:test_name + filter)
bazel test //utils:set_test --test_filter=TestSet_Add

# Fast local iteration (no race, no shuffle)
task bazel-test-fast               # or: bazel test --config=fast //...

# Collect coverage
bazel coverage //...

# Run E2E tests (requires built binary)
task bazel-test-e2e
```

#### Test Options

| Option | Default | Toggle with |
|--------|---------|-------------|
| Race detection | ON | `--config=norace` (disable) |
| Shuffle | ON | `--config=noshuffle` (disable) |
| Fast mode | - | `--config=fast` (no shuffle, no race) |

Examples:
```bash
# Disable race detection
bazel test --config=norace //...

# Disable shuffle only
bazel test --config=noshuffle //...

# Fast mode (no shuffle, no race)
bazel test --config=fast //...
```

#### Non-Unit Tests and the `manual` Tag

Tests that are not unit tests (e2e tests, integration tests, load
tests) must have `tags = ["manual"]` in their BUILD.bazel file. This
excludes them from `bazel test //...` which should only run unit
tests.

This roughly mirrors the behavior of `scripts/build_test.sh`, which excludes these directories via grep:
```bash
grep -v tests/e2e | grep -v tests/upgrade | grep -v tests/fixture/bootstrapmonitor/e2e | ...
```

**Tests with `manual` tag:**

| Test | BUILD.bazel Location |
|------|---------------------|
| Main E2E tests | `tests/e2e/BUILD.bazel` |
| Upgrade tests | `tests/upgrade/BUILD.bazel` |
| Bootstrap monitor E2E | `tests/fixture/bootstrapmonitor/e2e/BUILD.bazel` |
| Subnet-EVM warp tests | `graft/subnet-evm/tests/warp/BUILD.bazel` |
| Subnet-EVM load tests | `graft/subnet-evm/tests/load/BUILD.bazel` |
| Coreth warp tests | `graft/coreth/tests/warp/BUILD.bazel` |

**When adding new non-unit tests**, add the manual tag:
```python
go_test(
    name = "my_e2e_test",
    srcs = ["my_e2e_test.go"],
    tags = ["manual"],  # Not a unit test
    deps = [...],
)
```

### Maintenance

```bash
# Update BUILD files
task bazel-gazelle-generate                 # or: bazel run //:gazelle

# Format BUILD files
task bazel-fmt                     # or: buildifier -r .

# Update MODULE.bazel use_repo calls
task bazel-mod-tidy               # or: bazel mod tidy

# Clean build outputs
task bazel-clean                  # or: bazel clean

# Full cache clean
task bazel-clean-all              # or: bazel clean --expunge

# Delete generated BUILD files (for clean regeneration)
task bazel-gazelle-delete

# CI: verify BUILD files are up-to-date
task check-bazel-gazelle-generate
```

## Adding a New Go Module

When adding a new Go module under `graft/`:

1. **Create the module's go.mod and add to go.work**:
   ```
   go work use ./graft/newmodule
   ```

2. **Create the module's root BUILD.bazel** with the gazelle prefix:
   ```python
   # graft/newmodule/BUILD.bazel
   # gazelle:prefix github.com/ava-labs/avalanchego/graft/newmodule
   ```

3. **Run gazelle** to generate BUILD.bazel files:
   ```bash
   task bazel-gazelle-generate
   ```

Dependencies are resolved automatically via `go.work`.

## Troubleshooting

### "no such package" or import errors

Run gazelle to regenerate BUILD files:
```bash
task bazel-gazelle-generate
```

### Missing external dependency

1. Check if it's in `go.mod` - if not, add it
2. Run `task go-mod-tidy` (this runs `go mod tidy` in all modules,
   syncs the workspace, and runs `bazel mod tidy`)

### CGO compilation errors

Check `.bazelrc` for required CGO flags. CGO is enabled via
`--action_env=CGO_ENABLED=1`.

### Build cache issues

```bash
task bazel-clean-all
```

### "duplicate target" errors

Usually means gazelle created a target that conflicts with a
manually-defined one. Check for custom content in the BUILD.bazel
file.

## CGO Configuration

CGO is enabled via environment variables in `.bazelrc`:

```
build --action_env=CGO_ENABLED=1
build --action_env=CGO_CFLAGS="-O2 -D__BLST_PORTABLE__"
```

Some packages require specific CGO flags (e.g., BLST
cryptography). These are configured in `.bazelrc` or handled via
patches.

## Version Stamping

The main binary includes Git commit information via `x_defs` in
`main/BUILD.bazel`:

```python
go_binary(
    name = "avalanchego",
    embed = [":main_lib"],
    x_defs = {
        "github.com/ava-labs/avalanchego/version.GitCommit": "{STABLE_GIT_COMMIT}",
    },
)
```

Stamping is enabled via the `release` config in `.bazelrc`:

```bash
bazel build //main:avalanchego                    # Dev build (no stamp, cached)
bazel build --config=release //main:avalanchego   # Release build (stamped)
```

## Future Improvements

The following improvements are planned or under consideration:

### Remote Caching

Currently only local disk cache is configured
(`~/.cache/bazel-disk-cache`). Remote caching would enable:
- Cache sharing between CI runs
- Faster builds for new team members
- Cross-machine cache reuse

Implementation: Add BuildBuddy, Buildkite or similar remote cache service.

### CI Integration

- **Migrate CI to Bazel** - Update GitHub Actions to use Bazel for
  builds/tests where possible
- **Retain non-Bazel coverage** - Keep traditional `go build` CI jobs
  to support third-party consumers who don't use Bazel

### gnark-crypto Assembly Handling

gnark-crypto uses Go assembly with relative `#include` paths, which do
not work in Bazel sandboxes. A patch in `.bazel/patches/` rewrites those
includes so the asm can build under Bazel.

Potential follow-ups:
- Upstream the include-path fix to consensys/gnark-crypto
- Drop the patch once upstream releases a Bazel-compatible layout

### Patch Maintenance

External dependency patches in `.bazel/patches/` should be reviewed periodically:
- Check if upstream projects have improved Bazel support
- Test patches against dependency updates
- Consider upstreaming BUILD files where feasible

### Test Configuration

Graft modules already have custom test timeouts via `gazelle:map_kind`
(see "Custom Test Macros" section). Consider further stratification:
- Root module unit tests: shorter timeout (60s instead of 120s)
- Integration tests: medium timeout (300s)
- E2E tests: explicit long timeout (currently use `manual` tag)

## References

- [rules_go documentation](https://github.com/bazelbuild/rules_go)
- [Gazelle documentation](https://github.com/bazelbuild/bazel-gazelle)
- [Bazel Go Tutorial](https://bazel.build/start/go)
