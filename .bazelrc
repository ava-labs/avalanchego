# Go settings - match scripts/build_test.sh defaults
# Build tags - purego for gnark-crypto (assembly has cross-package includes that break in Bazel)
# TODO: Remove purego tag once gnark-crypto assembly is properly configured
build --@io_bazel_rules_go//go/config:tags=purego

# Test settings (match scripts/build_test.sh)
test --test_output=errors
test --test_timeout=120
# Set HOME for tests that need it (e.g., config tests that expand $HOME/.avalanchego)
test --test_env=HOME

# Race detection OFF by default (faster local builds)
# Enable with: bazel build/test --config=race //...
build:race --@io_bazel_rules_go//go/config:race=true
test:race --@io_bazel_rules_go//go/config:race=true

# Shuffle ON by default (matches build_test.sh -shuffle=on)
# Disable with: bazel test --config=noshuffle //...
test --test_arg=-test.shuffle=on

# Coverage: use `bazel coverage //...` instead of `bazel test //...`
# This matches build_test.sh's -coverprofile/-covermode flags

# CGO settings
# Using action_env rather than --@io_bazel_rules_go//go/config:pure because:
# 1. CGO_CFLAGS has no native rules_go equivalent - action_env is the only option
# 2. Using action_env for both CGO_ENABLED and CGO_CFLAGS keeps configuration consistent
# The BLST library requires -D__BLST_PORTABLE__ for portable builds across CPU architectures.
build --action_env=CGO_CFLAGS="-O2 -D__BLST_PORTABLE__"
build --action_env=CGO_ENABLED=1

# Cache for faster builds
build --disk_cache=~/.cache/bazel-disk-cache

# Config: disable shuffle (for deterministic test ordering)
test:noshuffle --test_arg=-test.shuffle=off

# Config: fast local development (no shuffle - race already off by default)
test:fast --config=noshuffle

# Stamp builds with git commit
build:release --stamp
build:release --workspace_status_command=scripts/bazel_workspace_status.sh
