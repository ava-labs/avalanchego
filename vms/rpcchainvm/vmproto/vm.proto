syntax = "proto3";

package vmproto;

option go_package = "github.com/ava-labs/avalanchego/vms/rpcchainvm/vmproto";

// To compile: protoc --go_out=plugins=grpc:. vm.proto

message InitializeRequest {
    uint32 networkID = 1;
    bytes subnetID = 2;
    bytes chainID = 3;
    bytes nodeID = 4;
    bytes xChainID = 5;
    bytes avaxAssetID = 6;
    bytes genesisBytes = 7;
    bytes upgradeBytes = 8;
    bytes configBytes = 9;

    repeated VersionedDBServer dbServers = 10;
    uint32 engineServer = 11;
    uint32 keystoreServer = 12;
    uint32 sharedMemoryServer = 13;
    uint32 bcLookupServer = 14;
    uint32 snLookupServer = 15;

    bytes epochFirstTransition = 16;
    uint64 EpochDuration = 17;
}

message InitializeResponse {
    bytes lastAcceptedID = 1;
    bytes lastAcceptedParentID = 2;
    uint32 status = 3;
    uint64 height = 4;
    bytes bytes = 5;
}

message VersionedDBServer {
    uint32 dbServer = 1;
    string version = 2;
}

message EmptyMsg {}

message CreateHandlersResponse {
    repeated Handler handlers = 1;
}

message CreateStaticHandlersResponse {
    repeated Handler handlers = 1;
}

message Handler {
    string prefix = 1;
    uint32 lockOptions = 2;
    uint32 server = 3;
}

message BuildBlockResponse {
    bytes id = 1;
    bytes parentID = 2;
    bytes bytes = 3;
    uint64 height = 4;
    // status is always processing
}

message ParseBlockRequest {
    bytes bytes = 1;
}

message ParseBlockResponse {
    bytes id = 1;
    bytes parentID = 2;
    uint32 status = 3;
    uint64 height = 4;
}

message GetBlockRequest {
    bytes id = 1;
}

message GetBlockResponse {
    bytes parentID = 1;
    bytes bytes = 2;
    uint32 status = 3;
    uint64 height = 4;
}

message SetPreferenceRequest {
    bytes id = 1;
}

message BlockVerifyRequest {
    bytes bytes = 1;
}

message BlockAcceptRequest {
    bytes id = 1;
}

message BlockRejectRequest {
    bytes id = 1;
}

message HealthResponse {
    string details = 1;
}

message VersionResponse {
    string version = 1;
}

message AppRequestMsg {
    // The node that sent us this request
    bytes nodeID = 1;
    // The ID of this request
    uint32 requestID = 2;
    // The request body
    bytes request = 3;
}

message AppRequestFailedMsg {
    // The node that we failed to get a response from
    bytes nodeID = 1;
    // The ID of the request we sent and didn't get a response to
    uint32 requestID = 2;
}

message AppResponseMsg {
    // The node that we got a response from
    bytes nodeID = 1;
    // Request ID of request that this is in response to
    uint32 requestID = 2;
    // The response body
    bytes response = 3;
}

message AppGossipMsg {
    // The node that sent us a gossip message
    bytes nodeID = 1;
    // The message body
    bytes msg = 2;
}

service VM {
    rpc Initialize(InitializeRequest) returns (InitializeResponse);
    rpc Bootstrapping(EmptyMsg) returns (EmptyMsg);
    rpc Bootstrapped(EmptyMsg) returns (EmptyMsg);
    rpc Shutdown(EmptyMsg) returns (EmptyMsg);
    rpc CreateHandlers(EmptyMsg) returns (CreateHandlersResponse);
    rpc CreateStaticHandlers(EmptyMsg) returns (CreateStaticHandlersResponse);
    rpc BuildBlock(EmptyMsg) returns (BuildBlockResponse);
    rpc ParseBlock(ParseBlockRequest) returns (ParseBlockResponse);
    rpc GetBlock(GetBlockRequest) returns (GetBlockResponse);
    rpc SetPreference(SetPreferenceRequest) returns (EmptyMsg);
    rpc Health(EmptyMsg) returns (HealthResponse);
    rpc Version(EmptyMsg) returns (VersionResponse);
    rpc AppRequest(AppRequestMsg) returns (EmptyMsg);
    rpc AppRequestFailed(AppRequestFailedMsg) returns (EmptyMsg);
    rpc AppResponse(AppResponseMsg) returns (EmptyMsg);
    rpc AppGossip(AppGossipMsg) returns (EmptyMsg);

    rpc BlockVerify(BlockVerifyRequest) returns (EmptyMsg);
    rpc BlockAccept(BlockAcceptRequest) returns (EmptyMsg);
    rpc BlockReject(BlockRejectRequest) returns (EmptyMsg);
}
